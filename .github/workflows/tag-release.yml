name: Konado Tag Release

on:
  push:
    tags:
      - 'v*'  # 匹配所有以v开头的Tag（符合语义化版本规范）
  workflow_dispatch:  # 保留手动触发，方便测试/紧急发布

env:
  GODOT_VERSION: 4.6
  EXPORT_NAME: "konado-demo"
  PROJECT_PATH: "."

jobs:
  build:
    runs-on: ubuntu-24.04
    container:
      image: barichello/godot-ci:4.6
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 1  # 只拉取最近一次commit

      - name: Setup Godot Export Templates
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates/
          mkdir -v -p ~/.config/
          mv /root/.config/godot ~/.config/godot
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
        shell: bash  # 显式指定bash

      - name: Extract project version
        id: get_version
        run: |
          # Tag推送触发，提取Tag版本
          if [ "${{ github.event_name }}" = "push" -a "${{ github.ref_type }}" = "tag" ]; then
              # 健壮解析Tag版本：refs/tags/v2.0.1 → 2.0.1
              TAG_FULL_NAME=$(echo "${{ github.ref }}" | awk -F '/' '{print $3}')  # 提取 v2.0.1
              TAG_VERSION=$(echo "$TAG_FULL_NAME" | sed 's/^v//')                # 去掉开头的v → 2.0.1
              
              # 严格校验Tag版本格式
              if [ -z "$TAG_VERSION" ]; then
                  echo "错误：从Tag [$TAG_FULL_NAME] 提取版本失败！"
                  exit 1
              fi

              echo "base_version=$TAG_VERSION" >> $GITHUB_OUTPUT
              echo "Tag触发：使用Tag版本 → $TAG_VERSION"
          fi
        shell: bash  # 显式指定bash

      - name: Generate release metadata
        id: version
        run: |
          git config --global --add safe.directory /__w/konado/konado

          # 版本号直接使用Tag中的版本
          BUILD_VERSION="${{ steps.get_version.outputs.base_version }}"
          if [ -z "$BUILD_VERSION" ]; then
              BUILD_VERSION="0.0.0-unknown"
              echo "警告：未从Tag提取到版本，使用兜底版本 → $BUILD_VERSION"
          fi
          echo "build_version=$BUILD_VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=v$BUILD_VERSION" >> $GITHUB_OUTPUT
          echo "release_name=Konado Release $BUILD_VERSION" >> $GITHUB_OUTPUT
          # 自定义Release描述
          echo "release_desc=**Official release of Konado $BUILD_VERSION**" >> $GITHUB_OUTPUT
          echo "plugin_zip=konado-${BUILD_VERSION}.zip" >> $GITHUB_OUTPUT
          echo "plugin_dotnet_zip=konadotnet-${BUILD_VERSION}.zip" >> $GITHUB_OUTPUT
        shell: bash  # 显式指定bash

      - name: Create export presets
        run: |
          rm -f ${{ env.PROJECT_PATH }}/export_presets.cfg
          cat > ${{ env.PROJECT_PATH }}/export_presets.cfg << EOF
          [preset.0]
          name="Linux/X11"
          platform="Linux/X11"
          runnable=true
          export_path="build/linux/${{ env.EXPORT_NAME }}-linux.x86_64"
          
          [preset.0.options]
          binary_format/embed_pck=true
          
          [preset.1]
          name="Windows Desktop"
          platform="Windows Desktop"
          runnable=true
          export_path="build/windows/${{ env.EXPORT_NAME }}-windows.exe"
          
          [preset.1.options]
          binary_format/embed_pck=true
          EOF
        shell: bash  # 显式指定bash

      - name: Build for Linux
        run: |
          mkdir -v -p build/linux
          EXPORT_DIR="$(readlink -f build)"
          cd ${{ env.PROJECT_PATH }}
          godot --headless --verbose --export-release "Linux/X11" "$EXPORT_DIR/linux/${{ env.EXPORT_NAME }}-linux.x86_64"
        shell: bash  # 显式指定bash

      - name: Build for Windows
        run: |
          mkdir -v -p build/windows
          EXPORT_DIR="$(readlink -f build)"
          cd ${{ env.PROJECT_PATH }}
          godot --headless --verbose --export-release "Windows Desktop" "$EXPORT_DIR/windows/${{ env.EXPORT_NAME }}-windows.exe"
        shell: bash  # 显式指定bash

      - name: Create Plugin Zip
        run: |
          mkdir -v -p build/plugins
          cd addons || exit 1
          zip -r "../build/plugins/${{ steps.version.outputs.plugin_zip }}" konado
          zip -r "../build/plugins/${{ steps.version.outputs.plugin_dotnet_zip }}" konadotnet
          cd - || exit 1
          ls -l build/plugins
        shell: bash  # 显式指定bash

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: ${{ steps.version.outputs.release_name }}
          body: ${{ steps.version.outputs.release_desc }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            build/plugins/${{ steps.version.outputs.plugin_zip }}
            build/plugins/${{ steps.version.outputs.plugin_dotnet_zip }}
            build/linux/${{ env.EXPORT_NAME }}-linux.x86_64
            build/windows/${{ env.EXPORT_NAME }}-windows.exe