name: Konado Daily Build

on:
  schedule:
    - cron: '0 0 * * *'  # 每日UTC 0点触发
  workflow_dispatch:  # 手动触发

env:
  GODOT_VERSION: 4.6
  EXPORT_NAME: "konado-demo"
  PROJECT_PATH: "."

jobs:
  check_new_commits:
    runs-on: ubuntu-24.04
    outputs:
      has_new_commits: ${{ steps.check.outputs.has_new_commits }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0  # 拉取完整历史（定时触发需查Tag/Commit）

      - name: Check for new commits since last tag (or force manual build)
        id: check
        run: |
          # 核心：判断触发类型，手动触发直接强制构建
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Manual trigger detected: force build regardless of new commits"
            echo "has_new_commits=true" >> $GITHUB_OUTPUT
            exit 0  # 跳过后续检查，直接退出
          fi

          # 定时触发：执行原有提交检查逻辑
          # 获取上一个Tag（无Tag则取初始提交）
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || git rev-list --max-parents=0 HEAD)
          echo "Last tag/commit: $LAST_TAG"

          # 检查上一个Tag之后是否有新Commit
          NEW_COMMITS=$(git log --pretty=format:"%h" $LAST_TAG..HEAD)
          
          if [ -n "$NEW_COMMITS" ]; then
            echo "Found new commits since last tag: $LAST_TAG (scheduled trigger)"
            echo "has_new_commits=true" >> $GITHUB_OUTPUT
          else
            echo "No new commits since last tag: $LAST_TAG, aborting scheduled build"
            echo "has_new_commits=false" >> $GITHUB_OUTPUT
          fi

  # 构建Job：依赖检查结果
  build:
    needs: check_new_commits
    if: needs.check_new_commits.outputs.has_new_commits == 'true'
    runs-on: ubuntu-24.04
    container:
      image: barichello/godot-ci:4.6
    permissions:
      contents: write  # 需该权限删除Tag/Release

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true
        fetch-depth: 0

    - name: Setup Godot Export Templates
      run: |
        mkdir -v -p ~/.local/share/godot/export_templates/
        mkdir -v -p ~/.config/
        mv /root/.config/godot ~/.config/godot
        mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

    - name: Extract project version
      id: get_version
      run: |
        if grep -q '^config/version=' ${{ env.PROJECT_PATH }}/project.godot; then
          BASE_VERSION=$(grep '^config/version=' ${{ env.PROJECT_PATH }}/project.godot | cut -d'=' -f2 | tr -d '" ')
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "the base version is $BASE_VERSION"
        else
          echo "base_version=1.0.0" >> $GITHUB_OUTPUT
        fi

    - name: Generate build version
      id: version
      run: |
        git config --global --add safe.directory /__w/konado/konado

        BUILD_DATE=$(date -u '+%Y%m%d')
        COMMIT_SHA_SHORT=$(git rev-parse --short HEAD)
        
        BUILD_VERSION="${{ steps.get_version.outputs.base_version }}-daily.$BUILD_DATE.$COMMIT_SHA_SHORT"
        echo "build_version=$BUILD_VERSION" >> $GITHUB_OUTPUT
        echo "tag_name=v$BUILD_VERSION" >> $GITHUB_OUTPUT
        echo "release_name=Konado Daily Build $BUILD_VERSION" >> $GITHUB_OUTPUT
        echo "release_desc=**This is a daily build of Konado, built on $BUILD_DATE. Please don't use this version for production.**" >> $GITHUB_OUTPUT
        echo "plugin_zip=konado-${BUILD_VERSION}.zip" >> $GITHUB_OUTPUT
        echo "plugin_dotnet_zip=konadotnet-${BUILD_VERSION}.zip" >> $GITHUB_OUTPUT

    - name: Create export presets
      run: |
        rm -f ${{ env.PROJECT_PATH }}/export_presets.cfg
        cat > ${{ env.PROJECT_PATH }}/export_presets.cfg << EOF
        [preset.0]
        name="Linux/X11"
        platform="Linux/X11"
        runnable=true
        export_path="build/linux/${{ env.EXPORT_NAME }}-linux.x86_64"
        
        [preset.0.options]
        binary_format/embed_pck=true
        
        [preset.1]
        name="Windows Desktop"
        platform="Windows Desktop"
        runnable=true
        export_path="build/windows/${{ env.EXPORT_NAME }}-windows.exe"
        
        [preset.1.options]
        binary_format/embed_pck=true
        EOF

    - name: Build for Linux
      run: |
        mkdir -v -p build/linux
        EXPORT_DIR="$(readlink -f build)"
        cd ${{ env.PROJECT_PATH }}
        godot --headless --verbose --export-release "Linux/X11" "$EXPORT_DIR/linux/${{ env.EXPORT_NAME }}-linux.x86_64"

    - name: Build for Windows
      run: |
        mkdir -v -p build/windows
        EXPORT_DIR="$(readlink -f build)"
        cd ${{ env.PROJECT_PATH }}
        godot --headless --verbose --export-release "Windows Desktop" "$EXPORT_DIR/windows/${{ env.EXPORT_NAME }}-windows.exe"

    - name: Create Plugin Zip
      run: |
        mkdir -v -p build/plugins
        cd addons || exit 1
        zip -r "../build/plugins/${{ steps.version.outputs.plugin_zip }}" konado
        zip -r "../build/plugins/${{ steps.version.outputs.plugin_dotnet_zip }}" konadotnet
        cd - || exit 1
        ls -l build/plugins

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.tag_name }}
        name: ${{ steps.version.outputs.release_name }}
        body: ${{ steps.version.outputs.release_desc }}
        draft: false
        prerelease: true
        generate_release_notes: false
        files: |
          build/plugins/${{ steps.version.outputs.plugin_zip }}
          build/plugins/${{ steps.version.outputs.plugin_dotnet_zip }}
          build/linux/${{ env.EXPORT_NAME }}-linux.x86_64
          build/windows/${{ env.EXPORT_NAME }}-windows.exe

    # 清理旧的每日构建
    - name: Install GitHub CLI
      shell: bash -e {0}
      run: |
        # 确保安装GitHub CLI（用于操作Release/Tag）
        type -p gh >/dev/null || (apt update && apt install -y gh)

    - name: Authenticate GitHub CLI
      shell: bash -e {0}
      run: |
        # 使用Action Token认证GH CLI
        echo "${{ github.token }}" | gh auth login --with-token

    - name: Cleanup Old Daily Builds
      shell: bash -e {0}
      run: |
        set -euo pipefail
        # 保留的每日构建数量
        KEEP_COUNT=10
        
        # 获取仓库中所有包含-daily.的Tag（仅匹配每日构建），按版本号降序排列
        echo "Fetching all daily build tags..."
        TAGS=$(gh api --method GET /repos/${{ github.repository }}/tags \
          --jq '.[] | select(.name | contains("-daily.")) | .name' \
          | sort -rV)
        
        # 转换为数组
        readarray -t TAG_ARRAY <<< "$TAGS"
        TOTAL_TAGS=${#TAG_ARRAY[@]}
        
        echo "Total daily build tags found: $TOTAL_TAGS"
        if [ $TOTAL_TAGS -le $KEEP_COUNT ]; then
          echo "No old tags to delete (keeping all $TOTAL_TAGS tags)"
          exit 0
        fi
        
        # 计算要删除的Tag（跳过前10个最新的）
        TAGS_TO_DELETE=("${TAG_ARRAY[@]:$KEEP_COUNT}")
        echo "Tags to delete (${#TAGS_TO_DELETE[@]}): ${TAGS_TO_DELETE[*]}"
        
        # 逐个删除Release和Tag
        for TAG in "${TAGS_TO_DELETE[@]}"; do
          echo "Processing tag: $TAG"
          
          # 删除对应的Release（如果存在）
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Deleting release for tag: $TAG"
            gh release delete "$TAG" -y
          else
            echo "No release found for tag: $TAG, skipping"
          fi
          
          # 删除Tag本身
          echo "Deleting tag: $TAG"
          gh api --method DELETE /repos/${{ github.repository }}/git/refs/tags/$TAG || echo "Tag $TAG may not exist, skipping"
        done